<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="navbar">
        {% if current_user.is_authenticated and current_user.is_admin %}
            {% include 'sidebar_admin.html' %}
        {% else %}
            {% include 'sidebar.html' %}
        {% endif %}
    </div>

    <div class="container">
        <!-- Dropdown to select Formdef ID -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select id="formdefSelect" class="form-select">
                    <!-- Options will be dynamically loaded -->
                </select>
            </div>
        </div>

        <!-- Container for the charts -->
        <div class="row" id="categoryChartsRow">
            <!-- Category charts will be dynamically added here -->
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const categoryChartsRow = document.getElementById("categoryChartsRow");
            const formdefSelect = document.getElementById("formdefSelect");

            // Fetch all formdef_ids from the server to populate the dropdown
            async function fetchFormDefs() {
                try {
                    const response = await fetch("/api/forms");
                    if (!response.ok) throw new Error("Failed to fetch form definitions");
                    const formDefs = await response.json();

                    // Populate the dropdown with formdef_id options
                    formDefs.forEach(form => {
                        const option = document.createElement("option");
                        option.value = form.id;  // formdef_id
                        option.textContent = form.name;  // form name
                        formdefSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error fetching form definitions:", error);
                }
            }

            // Fetch category scores based on selected formdef_id
            async function fetchCategoryScores(formdef_id) {
                try {
                    const response = await fetch(`/api/category_scores?formdef_id=${formdef_id}`);
                    if (!response.ok) throw new Error("Failed to fetch category scores");
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error("Error fetching category scores:", error);
                }
            }

            // Render charts for each category using Chart.js
            async function renderCategoryCharts(formdef_id) {
                const data = await fetchCategoryScores(formdef_id);
                if (!data) return;

                // Clear previous charts
                categoryChartsRow.innerHTML = "";

                // Create a chart for each category in the fetched data
                for (const category in data) {
                    const subcategories = data[category];
                    const chartDiv = document.createElement("div");
                    chartDiv.classList.add("col-md-6", "chart-container");

                    const canvas = document.createElement("canvas");
                    canvas.id = `${category}Chart`;

                    chartDiv.appendChild(canvas);
                    categoryChartsRow.appendChild(chartDiv);

                    const keys = subcategories.map(item => item.key);
                    const values = subcategories.map(item => item.count);

                    const ctx = canvas.getContext('2d');

                    // Create a bar chart for each category
                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: keys,
                            datasets: [{
                                label: `Count for ${category}`,
                                data: values,
                                backgroundColor: "rgba(50, 153, 103)",
                                borderColor: "rgba(5, 92, 49)",
                                borderWidth: 1,
                            }],
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: `Category: ${category}`
                                }
                            },
                        },
                    });
                }
            }

            // Event listener for formdef_id selection change
            formdefSelect.addEventListener("change", (event) => {
                const selectedFormdefId = event.target.value;
                if (selectedFormdefId) {
                    renderCategoryCharts(selectedFormdefId);
                }
            });

            // Initial load: Fetch formdefs and render charts for the first formdef_id
            fetchFormDefs().then(() => {
                if (formdefSelect.options.length > 0) {
                    const firstFormdefId = formdefSelect.options[0].value;
                    renderCategoryCharts(firstFormdefId);
                }
            });
        });
    </script>
</body>
</html>
